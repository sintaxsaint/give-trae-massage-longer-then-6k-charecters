<!DOCTYPE html>
<html>
<head><title>CacheQuest Specs</title></head>
<body>
<pre style="white-space: pre-wrap; font-family: monospace;">
Perfect! Here's a prompt optimized for Cline + MiniMax to build CacheQuest:
html<!DOCTYPE html>
<html>
<head><title>CacheQuest Build Prompt for Cline</title></head>
<body>
<pre style="white-space: pre-wrap; font-family: monospace;">
# CLINE BUILD INSTRUCTIONS - CacheQuest Backend

You are building a Cloudflare Worker backend with D1 database. Work step-by-step, one file at a time.

## CRITICAL RULES
1. Ask before creating each file
2. Show me the code before writing it
3. Test each endpoint individually
4. Use simple, clear variable names
5. Add comments explaining logic

## BUILD ORDER (Do these ONE AT A TIME)

### Step 1: Project Setup
Create these files in order:
1. wrangler.toml - Basic config
2. schema.sql - Just the tables
3. package.json - Dependencies only

Ask me to verify each before moving on.

### Step 2: Utility Functions (src/utils.js)
Build ONLY these functions:
```javascript
// 1. Haversine distance calculator (3 meter check)
export function getDistanceInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const φ1 = lat1 * Math.PI / 180;
  const φ2 = lat2 * Math.PI / 180;
  const Δφ = (lat2 - lat1) * Math.PI / 180;
  const Δλ = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(Δφ/2) * Math.sin(Δφ/2) +
            Math.cos(φ1) * Math.cos(φ2) *
            Math.sin(Δλ/2) * Math.sin(Δλ/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

// 2. Generate random token
export function generateToken() {
  return crypto.randomUUID();
}

// 3. Get current UK time and determine chunk
export function getCurrentChunk() {
  const now = new Date();
  const hours = now.getHours();
  const minutes = now.getMinutes();
  const time = hours * 60 + minutes;
  
  // 09:00-10:20 = START (540-620 mins)
  // 10:40-12:40 = MIDDLE (640-760 mins)  
  // 13:40-15:40 = END (820-940 mins)
  
  if (time >= 540 && time <= 620) return 'START';
  if (time >= 640 && time <= 760) return 'MIDDLE';
  if (time >= 820 && time <= 940) return 'END';
  return null; // Inactive time
}

// 4. Calculate when cache should reactivate
export function calculateReactivation(claimedChunk, claimTime) {
  // START -> END same day
  // MIDDLE -> START next day
  // END -> MIDDLE next day
  // Return Unix timestamp
}
```

Stop after utils.js and let me test it.

### Step 3: Authentication (src/auth.js)
Build ONLY:
- hashPassword(password) - Use bcrypt
- verifyPassword(password, hash)
- generateJWT(userId, tier)
- verifyJWT(token)

Test these before moving on.

### Step 4: Database Queries (src/db.js)
Build simple query functions:
- getUser(username)
- createUser(username, passwordHash)
- getUserById(id)
- getCache(cacheId)
- getCacheByHalfCode(halfCode)
- updateCacheStatus(cacheId, status, reactivateTime)

NO COMPLEX LOGIC YET. Just simple SELECT/INSERT/UPDATE.

### Step 5: Cache Logic (src/cache.js)
Build ONE function at a time:

1. verifyLocation(halfCode, lat, lng, userId, db)
   - Find cache by half_code
   - Check distance < 3 meters
   - Create pending_claim
   - Return verification token

2. claimCache(verificationToken, userId, db)
   - Check if pending_claim exists and not expired
   - Check if cache still active
   - Award points (FIRST person wins)
   - Deactivate cache
   - Calculate reactivation time

3. getActiveCaches(userTier, db)
   - Return caches where status='active'
   - Filter response by tier (free/budget/premium)

Build and test EACH function separately.

### Step 6: Main Router (src/index.js)
Wire up routes ONE AT A TIME:
- POST /api/auth/register
- POST /api/auth/login
- POST /api/cache/verify-location
- POST /api/cache/claim
- GET /api/cache/active

Test each endpoint with curl or Postman before adding the next.

### Step 7: Leaderboard (src/leaderboard.js)
Simple SQL queries only:
- getCurrentLeaderboard() - ORDER BY points DESC
- getLifetimeLeaderboard() - ORDER BY lifetime_points DESC

### Step 8: Cron Job (src/cron.js)
Handle scheduled reactivation:
- Run every 5 minutes
- Check if in active window
- Reactivate caches where deactivated_until <= now

## DATABASE SCHEMA

CREATE TABLE users (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  username TEXT UNIQUE NOT NULL,
  password_hash TEXT NOT NULL,
  points INTEGER DEFAULT 0,
  lifetime_points INTEGER DEFAULT 0,
  subscription_tier TEXT DEFAULT 'free',
  hints_used_this_week INTEGER DEFAULT 0,
  hints_used_this_term INTEGER DEFAULT 0,
  created_at INTEGER DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE caches (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  cache_number INTEGER UNIQUE NOT NULL,
  half_code TEXT UNIQUE NOT NULL,
  wordle_word TEXT NOT NULL,
  location_lat REAL NOT NULL,
  location_lng REAL NOT NULL,
  location_area TEXT NOT NULL,
  points_value INTEGER NOT NULL,
  rarity TEXT NOT NULL,
  chunk TEXT NOT NULL,
  status TEXT DEFAULT 'active',
  deactivated_until INTEGER,
  created_at INTEGER DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE pending_claims (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  cache_id INTEGER NOT NULL,
  verification_token TEXT UNIQUE NOT NULL,
  expires_at INTEGER NOT NULL,
  created_at INTEGER DEFAULT (strftime('%s', 'now'))
);

CREATE TABLE claims (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER NOT NULL,
  cache_id INTEGER NOT NULL,
  points_awarded INTEGER NOT NULL,
  claimed_at INTEGER DEFAULT (strftime('%s', 'now'))
);

## TESTING CHECKLIST

After each step, test:
1. Does the code compile?
2. Can you call the function?
3. Does it return expected output?
4. Does it handle errors?

## COMMON MISTAKES TO AVOID

❌ Don't build everything at once
❌ Don't use complex async/await chains
❌ Don't forget error handling
❌ Don't skip testing steps

✅ One file at a time
✅ Simple, clear code
✅ Test after each change
✅ Ask before proceeding

## DEPENDENCIES (package.json)

{
  "name": "cachequest-worker",
  "version": "1.0.0",
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "jose": "^5.0.0"
  }
}

## ENVIRONMENT VARIABLES

Set these in Cloudflare dashboard:
- JWT_SECRET (generate random 256-bit string)
- ADMIN_TOKEN (generate random string)

## START HERE

Begin with: "Let's start with Step 1. Create wrangler.toml with basic Cloudflare Worker configuration."

Wait for my approval before moving to Step 2.
</pre>
</body>
</html>
</pre>
</body>
</html>
